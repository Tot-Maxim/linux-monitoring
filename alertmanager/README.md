# Alerting
**Alertmanager** — это компонент экосистемы Prometheus, который отвечает за обработку, группировку, подавление и отправку оповещений (алертов) на основе данных, полученных от Prometheus или других источников. Его основная задача — управлять потоком оповещений, чтобы избежать перегрузки пользователей или систем уведомлений, а также обеспечить удобное и своевременное информирование о проблемах.

## Расширенная схема: Alertmanager + Grafana

```mermaid
sequenceDiagram
    participant App as "Приложение (App)"
    participant Exporter as "Экспортер"
    participant Prometheus as "Prometheus Server"
    participant Alertmanager as "Alertmanager"
    participant Grafana as "Grafana"

    Exporter->>App: Вызов API приложения
    App-->>Exporter: Предоставление данных через API

    loop Каждые N секунд
        Prometheus->>Exporter: HTTP GET (Pull метрик)
        Exporter-->>Prometheus: HTTP 200 OK + Текстовые метрики
    end

    opt Если условия алерта выполнены
        Prometheus->>Alertmanager: HTTP POST (Отправка алертов)
        Alertmanager->>Grafana: Интеграция алертов в интерфейс Grafana
    end

    loop По запросу пользователя в Grafana
        Grafana->>Prometheus: HTTP GET (Запрос метрик)
        Prometheus-->>Grafana: HTTP 200 OK + Метрики в формате JSON
    end
```

**Описание схемы:**  
- Prometheus собирает метрики и проверяет условия алертов.
- Если условия выполнены, Prometheus отправляет алерты в Alertmanager.
- Alertmanager может интегрироваться с Grafana для отображения алертов.
- Grafana запрашивает метрики у Prometheus для визуализации.

---

### **Основные задачи Alertmanager:**
1. **Группировка оповещений**:
   - Объединяет несколько связанных оповещений в одно, чтобы избежать дублирования и уменьшить количество уведомлений.
   - Например, если несколько серверов одновременно сообщают о проблеме, Alertmanager может отправить одно общее уведомление.

2. **Подавление оповещений (Inhibition)**:
   - Подавляет менее важные оповещения, если уже сработало более критическое.
   - Например, если сработал алерт о недоступности всего кластера, то оповещения о проблемах на отдельных узлах могут быть подавлены.

3. **Маршрутизация оповещений (Routing)**:
   - Направляет оповещения разным получателям (например, в разные каналы Slack, Telegram, email) в зависимости от меток (labels) и правил маршрутизации.

4. **Повторная отправка оповещений**:
   - Если проблема не решена, Alertmanager может повторно отправлять оповещения через заданные интервалы времени.

5. **Обработка состояний "Resolved"**:
   - Отправляет уведомления о том, что проблема была решена (если это настроено).

---

### **Основные компоненты Alertmanager:**

1. **Конфигурационный файл (`alertmanager.yml`)**:
   - Определяет, как Alertmanager должен обрабатывать и отправлять оповещения.
   - Включает настройки:
     - **Глобальные параметры** (например, время разрешения оповещений).
     - **Маршруты (routes)** — правила маршрутизации оповещений.
     - **Получатели (receivers)** — каналы отправки уведомлений (Slack, Telegram, email и т.д.).
     - **Правила подавления (inhibit_rules)** — условия для подавления менее важных оповещений.

2. **API Alertmanager**:
   - Предоставляет интерфейс для управления оповещениями, их статусами и конфигурацией.
   - Используется для интеграции с другими системами.

3. **Веб-интерфейс**:
   - Позволяет просматривать текущие оповещения, их статусы и настройки маршрутизации.

4. **Интеграции с каналами уведомлений**:
   - Поддерживает множество каналов для отправки оповещений, таких как:
     - Slack
     - Telegram
     - Email
     - PagerDuty
     - Webhook (для интеграции с другими системами)

---

### **Как работает Alertmanager:**
1. Prometheus отправляет оповещения в Alertmanager на основе правил, определенных в `alert.rules`.
2. Alertmanager принимает эти оповещения и применяет к ним правила маршрутизации, группировки и подавления.
3. В зависимости от конфигурации, Alertmanager отправляет уведомления в соответствующие каналы (например, в Telegram или Slack).
4. Если проблема решена, Prometheus отправляет соответствующий сигнал, и Alertmanager может уведомить об этом.

---

### **Ключевые преимущества Alertmanager:**
- **Гибкость**: Настройка маршрутизации и группировки под конкретные нужды.
- **Масштабируемость**: Обработка большого количества оповещений без перегрузки пользователей.
- **Интеграция**: Поддержка множества каналов уведомлений.
- **Подавление шума**: Уменьшение количества уведомлений за счет группировки и подавления.
---
