# PostgreSQL

## Установка и настройка мониторинга

_Сначала думаем над каждым заданием в разделе `Tasks`, если не можем понять какой-то инструмент не менее 40-ка минут и только потом смотрим этот раздел по пунктам!_

---

## **Шаг 1: Установка PostgreSQL**
PostgreSQL — это основная СУБД, в которой мы создадим базу данных.

1. **Обновите систему**:
   ```bash
   sudo apt update && sudo apt upgrade -y
   ```

2. **Установите PostgreSQL**:
   ```bash
   sudo apt install postgresql postgresql-contrib -y
   ```

3. **Запустите и настройте автозапуск PostgreSQL**:
   ```bash
   sudo systemctl start postgresql
   sudo systemctl enable postgresql
   ```

4. **Проверьте статус PostgreSQL**:
   ```bash
   sudo systemctl status postgresql
   ```

5. **Смените пароль пользователя `postgres`**:
   ```bash
   sudo -u postgres psql
   ALTER USER postgres PASSWORD 'ваш_пароль';
   \q
   ```

---

## **Шаг 2: Создание базы данных**
Теперь нужно выполнить SQL-скрипт для создания таблиц.

1. **Подключитесь к PostgreSQL**:
   Войдите в интерактивный терминал PostgreSQL:
   ```bash
   sudo -u postgres psql
   ```

2. **Создайте новую базу данных**:
   Выполните команду:
   ```sql
   CREATE DATABASE fintech_credit_conveyor;
   ```

3. **Подключитесь к созданной базе данных**:
   ```sql
   \c fintech_credit_conveyor
   ```

4. **Вставьте SQL-скрипт**:
   Теперь можно вставить SQL-скрипт из предыдущего ответа. Для этого:
   - Выделите весь SQL-код.
   - Вставьте его прямо в терминал `psql` (нажмите правой кнопкой мыши или используйте комбинацию `Ctrl+Shift+V`).

   Если вы хотите загрузить скрипт из файла:
   - Сохраните SQL-код в файл, например, `schema.sql`.
   - Загрузите его в PostgreSQL:
     ```bash
     sudo -u postgres psql -d fintech_credit_conveyor -f schema.sql
     ```

5. **Проверьте созданные таблицы**:
   Внутри `psql` выполните:
   ```sql
   \dt
   ```
   Вы увидите список созданных таблиц.

6. **Выйдите из PostgreSQL**:
   ```sql
   \q
   ```

---

## **Шаг 3: Установка и настройка postgres_exporter**
`postgres_exporter` нужен для мониторинга PostgreSQL через Prometheus.

1. **Установите `postgres_exporter`**:
   ```bash
   sudo apt install postgresql-exporter -y
   ```

2. **Создайте пользователя для мониторинга**:
   Подключитесь к PostgreSQL:
   ```bash
   sudo -u postgres psql
   ```
   Выполните:
   ```sql
   CREATE USER exporter WITH PASSWORD 'exporter_password';
   GRANT pg_monitor TO exporter;
   \q
   ```

3. **Настройте `postgresql.conf`**:
   Откройте файл конфигурации PostgreSQL:
   ```bash
   sudo nano /etc/postgresql/<version>/main/postgresql.conf
   ```
   Найдите строку `shared_preload_libraries` и измените её:
   ```conf
   shared_preload_libraries = 'pg_stat_statements'
   ```

4. **Настройте `pg_hba.conf`**:
   Откройте файл:
   ```bash
   sudo nano /etc/postgresql/<version>/main/pg_hba.conf
   ```
   Добавьте строку для пользователя `exporter`:
   ```conf
   host    all             exporter        127.0.0.1/32            md5
   ```

5. **Перезапустите PostgreSQL**:
   ```bash
   sudo systemctl restart postgresql
   ```

6. **Запустите `postgres_exporter`**:
   Настройте переменные окружения:
   ```bash
   export DATA_SOURCE_NAME="postgresql://exporter:exporter_password@localhost:5432/fintech_credit_conveyor?sslmode=disable"
   ```
   Запустите экспортер:
   ```bash
   postgres_exporter
   ```

---

## **Шаг 4: Интеграция с Prometheus**
1. **Установите Prometheus**:
   ```bash
   sudo apt install prometheus -y
   ```

2. **Настройте `prometheus.yml`**:
   Откройте файл конфигурации:
   ```bash
   sudo nano /etc/prometheus/prometheus.yml
   ```
   Добавьте таргет для `postgres_exporter`:
   ```yaml
   scrape_configs:
     - job_name: 'postgres'
       static_configs:
         - targets: ['localhost:9187']
   ```

3. **Перезапустите Prometheus**:
   ```bash
   sudo systemctl restart prometheus
   ```

4. **Проверьте метрики**:
   Откройте браузер и перейдите на адрес Prometheus:
   ```
   http://localhost:9090
   ```

---

## **Шаг 5: Интеграция с Grafana**
1. **Установите Grafana**:
   ```bash
   sudo apt install grafana -y
   ```

2. **Запустите и настройте автозапуск Grafana**:
   ```bash
   sudo systemctl start grafana-server
   sudo systemctl enable grafana-server
   ```

3. **Добавьте источник данных**:
   - Откройте Grafana в браузере:
     ```
     http://localhost:3000
     ```
   - Добавьте Prometheus как источник данных.

4. **Импортируйте дашборд**:
   - Используйте готовый дашборд для PostgreSQL (например, ID 9628) или создайте свой.

---

## **Итог**
Теперь у вас есть:
1. Рабочая база данных PostgreSQL с таблицами для финтех-проекта.
2. Мониторинг через `postgres_exporter`, Prometheus и Grafana.
3. Возможность добавлять данные и использовать их в вашем приложении.
