# Prometheus

## Backend

### Запускаем голый бинарь Prometheus, пишем юнит и простую автоматизацию
1. Изначально у вас должна быть установлена первичная `виртуалка А` в виде `Ubuntu 22.04` на английском языке:
   - После установки склонируйте её - это будет `виртуалка Б` и продолжайте работать на `виртуалке А`
   - В идеале сделать еще один клон с `виртуалкой С` и вообще его не трогать, чтобы она была, как резервная и `чистейшая ОС` на всякий случай
      - Если есть время, то научитесь делать `снимки ОС`, чтобы была возможность отката и тогда вам хватит первых двух виртуалок
   - Это нужно в целях резервирования и для выполнения дальнейших заданий
2. Взять директорию из корня за основную рабочую `/opt` (является частью стандартной файловой системы и предназначена для хранения дополнительного программного обеспечения):
   - Сделать себе в аккаунт **GitHub** [форк](https://github.com/lamjob1993/linux-monitoring/blob/main/%D0%A4%D0%BE%D1%80%D0%BA%20%D0%B2%20GitHub.md) репозитория [linux-monitoring](https://github.com/lamjob1993/linux-monitoring)
   - Далее склонировать ваш форкнутый репозиторий `linux-monitoring` в свою домашнюю директорию, к примеру в `/Downloads` или в `/Documents`:
      - Должна получиться домашняя клон-директория репозитория `/Documents/linux-monitoring/`:

                    /linux-monitoring      
                    ├── grafana             # Директория Grafana         
                    ├── node-exporter       # Директория Node Exporter
                    ├── prometheus          # Директория Prometheus
                    ├── e.t.c               # Остальные директории
  
3. Далее найти и скачать архив `.tar.gz` дистрибутива `Prometheus` для `Linux` самой последней второй (не третьей) версии в домашнюю директорию рядом со склонированным репозиторием `/Documents/linux-monitoring` (подсказка: GitHub, AMD64, bin)
4. Разархивировать архив и найти внутри директории бинарь `Prometheus` (директория после разархивации будет выглядеть, к примеру, вот так `/Documents/prometheus-2.53.2.linux-amd64`)
5. Проверить версию `Prometheus` (подсказка: `./prometheus --version` и запустить бинарь "на коленке" подсказка: `./bin/prometheus` или `./prometheus`)
6. Проверить запущенный на коленке `Prometheus` на веб-морде (подсказка: проверка должна быть в браузере на порту `:9090`, чтобы понять по какому ip адресу стучаться в `Prometheus`, нужно знать ip адрес интерфейса своей тачки (тачками называют машины и серверы - это синонимы))
7. Затем скопировать из домашней директории `/Documents/prometheus-2.53.2.linux-amd64` в домашнюю директорию `/Documents/linux-monitoring/prometheus` файлы:
   
                             /prometheus      
                             ├── prometheus.yml                    # ЭТОТ ФАЙЛ НУЖНО БУДЕТ СОЗДАТЬ САМОСТОЯТЕЛЬНО ПУСТЫМ / Основной конфигурационный файл Prometheus             
                             ├── prometheus                        # Бинарный файл Prometheus
                             ├── data                              # Директория, куда Prometheus пишет данные временных рядов
                             ├── consoles/                         # Директория для шаблонов консолей Prometheus
                             │   ├── index.html.example            # Пример главной страницы
                             │   ├── node-cpu.html                 # Шаблон консоли для мониторинга CPU узла
                             │   ├── node-disk.html                # Шаблон консоли для мониторинга диска узла
                             │   ├── node.html                     # Общий шаблон консоли для узла
                             │   ├── node-overview.html            # Обзорная консоль для узла
                             │   ├── prometheus.html               # Шаблон консоли для Prometheus
                             │   └── prometheus-overview.html      # Обзорная консоль для Prometheus
                             ├── console_libraries/                # Директория для библиотек шаблонов консолей
                             │   ├── menu.lib                      # Библиотека меню
                             │   └── prom.lib                      # Библиотека Prometheus
                             └── prometheus.service                # ЭТОТ ФАЙЛ НУЖНО БУДЕТ СОЗДАТЬ САМОСТОЯТЕЛЬНО ПУСТЫМ / Сервисный Unit-файл для запуска Prometheus
    
9. Где файл `unit_file` нужно написать с нуля (это файл отвечающий за запуск `Prometheus`)
10. Где файл `prometheus.yml` нужно написать с нуля (это основной конфиг-файл `Prometheus`). Подсказка как этот файл написать: `GitHub` - `prometheus/documentation/examples/prometheus.yml`
11. Далее скопировать рекурсивно директорию `/linux-monitoring` в директорию `/opt`
12. Далее одной командой выдать рекурсивно права `777` на директорию `/linux-monitoring` входящую в состав `/opt` (`/opt` не трогаем, оставляем под `root`)
13. Далее одной командой выдать права `777` на весь внутренний состав только рабочей директории `/prometheus` (это называется рекурсивно) по адресу `/opt/linux-monitoring/prometheus`
14. Обычно такие права `777` не выдаются (либо выдаются в песочнице: то есть представьте себе, что вы инженер по разработке и работаете на платформе `DEV`), но у нас учебный проект, поэтому имеем это ввиду:
    - Параллельно идем в `ИИ GPT Qwen` и учимся выставлять числовые права
    - Заодно учимся понимать, что такое `777` и как эти числа образуются `4+2+1`
15. Далее нужно создать группу пользователей `prometheus` и добавить туда пользователя `prometheus`:
    - Далее проверить эту группу пользователей, что `prometheus` добавился (одновременно идем в `ИИ GPT Qwen` и учимся назначать владельца на директорию и на файлы)
    - При дефолтной установке пакета `Prometheus`, будь то `.rpm` или `.deb` назначение прав и назначение владельца происходит автоматически
    - Здесь мы делаем назначение вручную, чтобы понимать логику работы команд: `chown` и `chmod`
16. Затем рекурсивно назначить владельца `prometheus` только для рабочей директории `/prometheus` по адресу `/opt/linux-monitoring/prometheus`:

               --права-- -владелец-  -группа-           /opt/linux-monitoring      
              drwxrwxrwx prometheus prometheus          ├── grafana             # Директория Grafana         
              drwxrwxrwx prometheus prometheus          ├── node-exporter       # Директория Node Exporter
              drwxrwxrwx prometheus prometheus          ├── prometheus          # Директория Prometheus

   
17. Рекурсивно назначить владельца `prometheus` только для домашней директории `/prometheus` по адресу `/Documents/linux-monitoring/prometheus/`:
    
           --права-- -владелец-  -группа-            /prometheus      
          -rwxrwxrwx prometheus prometheus           ├── prometheus.yml                 # Основной конфигурационный файл Prometheus             
          drwxrwxrwx prometheus prometheus           ├── consoles/                      # Директория для шаблонов консолей Prometheus
          -rwxrwxrwx prometheus prometheus           │   ├── index.html.example            # Пример главной страницы
          -rwxrwxrwx prometheus prometheus           │   ├── node-cpu.html                 # Шаблон консоли для мониторинга CPU узла
          -rwxrwxrwx prometheus prometheus           │   ├── node-disk.html                # Шаблон консоли для мониторинга диска узла
          -rwxrwxrwx prometheus prometheus           │   ├── node.html                     # Общий шаблон консоли для узла
          -rwxrwxrwx prometheus prometheus           │   ├── node-overview.html            # Обзорная консоль для узла
          -rwxrwxrwx prometheus prometheus           │   ├── prometheus.html               # Шаблон консоли для Prometheus
          -rwxrwxrwx prometheus prometheus           │   └── prometheus-overview.html      # Обзорная консоль для Prometheus
          drwxrwxrwx prometheus prometheus           ├── console_libraries/             # Директория для библиотек шаблонов консолей
          -rwxrwxrwx prometheus prometheus           │   ├── menu.lib                      # Библиотека меню
          -rwxrwxrwx prometheus prometheus           │   └── prom.lib                      # Библиотека Prometheus
          -rwxrwxrwx prometheus prometheus           └── prometheus.service             # Сервисный Unit-файл для запуска Prometheus

18. Затем скопировать уже написанный вами `Unit` в директорию `/etc/systemd/system/` автозапуска `Linux` с уже выставленными правами `777` и владельцем `prometheus`
19. Чтобы система `Linux` поняла, что файл сервиса `Unit` добавлен в директорию `/systemd`, нужно вбить команду `sudo systemctl daemon-reload`:
    - Тем самым обновляя директорию `/systemd` до актуального состояния
    - Далее ставим наш сервис на автозапуск (то есть при ребуте системы сервис `Prometheus` будет взлетать автоматом) `sudo systemctl enable`
    - Читаем подробно в `ИИ Qwen` про эту команду и заодно еще раз про пороцессы и демоны
20. Далее запускаем сервис `Prometheus` утилитой `systemctl` (в дефолте эта утилита смотрит в автозапуск `/systemd` и будет знать о том, что там лежит наш юнит):
    - Проверяем после запуска статус `ACTIVE` командой `sudo systemctl status prometheus.service` и смотрим на работающую веб-морду
    - А если `INACTIVE` или `FAIL`, то сразу читаем логи (смотрим следующий пункт темы)
    - Подсказка: смотрим в `Unit` либо смотрим в конфиг `YAML` в `Prometheus`, скорее всего ошиблись в одном из двух, часто бывают проблемы с выдачей прав и с неверными пользователями
21. Затем выводим логи `Prometheus` в терминал, которые отбрасывает запущенный `Prometheus` с помощью утилиты `journalctl`:
    - Параллельно для справки с помощью `Qwen` читаем, что такое: `stdin`, `stdout`, `stderr` 
22. Далее парсим (фильтруем) логи утилитой `grep` в файл `prometheus.log` по ключевому слову `info` (сохраняем логи в любое удобное место):
    - То есть конечный результат лога должен содержать только строки с `info`
    - Подсказка: `journalctl | grep` - используем перенаправление вывода из `journalctl` в `grep` с помощью пайпа `|`
    - А также подумайте, как с помощью `grep`:
       - Добавить новые записи в файл с сохранением в реальном времени (то есть не через однократное сохранение лога в файл) 
       - Грепать новые логи раз в минуту, записывая в файл:
          - Поставить мини-скрипт `grep` (перейти в домашнюю директорию `/Documents/linux-monitoring/prometheus`, создать внутри директорию `/scripts` и положить туда ваш первый скрипт `script_logs.sh`) в планировщик `crontab` на выполнение (подсказка: `0 * * * * /путь/к/script_logs.sh`, то есть `crontab` должен будет дёргать ваш мини-скрипт на выполнение раз в минуту):
             - Советую потренироваться в запуске вашего первого скрипта
             - К примеру для начала разобраться какие права ему выдать, чтобы он запустился с тестовой фразой в терминале: `Hello, World!!!`
23. Далее перезагружаем `Ubuntu-виртуалку` и проверяем автозапуск (`sudo systemctl status prometheus.service`), что юнит автоматически стартовал сервис `Prometheus` - он должен подняться на веб-морде
24. Далее пушим данные конфига `Prometheus` и всей структуры (исполняемые файлы не пушатся, только текстовые файлы, код, конфиги и прочее), находясь в домашней директории `/Documents/linux-monitoring/` в свой удаленный репозиторий (подсказка: сначала сделайте `git add .` потом `git commit -m "напишите какие файлы добавляете и что сделали"` и затем `git push`)
25. Далее, так как мы подняли `Prometheus` и он работает — пробежимся по дебагу (просто представим, что приложению нужен дебаг, как будто это инцидент в банке и его нужно решать, а `Prometheus` у нас не работает):
    
    - С помощью утилиты `ss` найдите `prometheus` и посмотрите на каком порту он сидит, заодно посмотрите какой это порт: `TCP` или `UDP`
    - С помощью утилиты `telnet` проверьте доступность соединения `Prometheus` по дефолтному порту `Prometheus` (подумайте как это сделать)
    - С помощью утилиты — `curl` гетом (`GET`) скурлите (постучитесь `GET-запросом`) в `API Prometheus`, который должен вернуть `HTTP статус 2xx`, если сервису хорошо и `HTTP статус 5xx`, если плохо (заодно подтягиваем тему: методы и коды `HTTP`)
    - С помощью команды `ps` найдите `PID` процесса `Prometheus` (подсказка: `ps aux | grep ...`) и попробуйте убить его командой `kill` (сначала прочитайте, как убивать процессы, сначала во встроенном руководстве `man`, а потом в `Qwen`)
    - А также в дебаг входит `journactl` и `systemctl status`
    - Команды можно комбинировать между собой

26. В домашнюю директорию `/Documents/linux-monitoring/prometheus` положить второй `Bash` скрипт, который должен делать всю ручную работу выше автоматически:
    - Этот скрипт в финале должен поднять `Prometheus` с нуля за секунды и вы должны увидеть в терминале статус сервиса `ACTIVE`, а затем перейти в браузер и увидеть его на веб-морде:
       - То есть ставим всё что мы делали вручную выше на автоматизацию
    - Коммитим изменения и пушим в `GitHub` второй скрипт на установку `Prometheus` (не запускаем)
    - Далее нужно модернизировать этот скрипт на полное удаление `Prometheus` из системы, включая юнит, только осторожнее с директорией `/opt` - ее удалять не нужно
    - Коммитим изменения и пушим в `GitHub` третий скрипт на полное удаление (не запускаем)
    - Писать эти скрипты строго используя логические операторы `&&` (и) и `||` (или):
       - То есть каждая строка скрипта должна выглядеть, как удаление директории `&&` вывод сообщения об успехе `||` вывод сообщения об ошибке:

               rm -rf /tmp/example && echo "Директория успешно удалена" || { echo "Ошибка удаления директории"; exit 1; }

    - Далее протестировать эти два скрипта на текущей машине (с учетом того, что все ваши файлы уже запушены в `GitHub` и вы можете делать всё что угодно на этой машине, имеем только ввиду, что исполняемые файлы (бинарники) нельзя пушить в `GitHub`, поэтому эта тема написана таким образом, что пушить вы будете только текстовые файлы с кодом и с конфигурацией, как раз из директории локального репозитория)
27. Далее перейти в виртуальную машину `Ubuntu Б` из `п.1` и запустить её рядом с вашей машиной `Ubuntu А`
28. Прогнать из пункта выше готовый скрипт запуска `Prometheus` на голой машине Б:
    - Затем удалить `Prometheus` вторым скриптом (не забываем стопнуть `Prometheus` перед удалением, а после удаления сделать `daemon-reload`)
29. Подумать, как установить между этими двумя тачками `А` и `Б` соединение `SSH`, чтобы можно было ходить из одной машины в другую:
    - Подсказка: потренироваться генерить `SSH ключи` и понять, что такое публичный и закрытый ключи
    - Подсказка: после клона на `виртуалках А и Б` будут одинаковые `IP адреса`, нужно выключить обе виртуалки и прописать на каждой по 2 адаптера (один из сетевых адаптеров уже существует):
      - `Виртуалка А`: Сетевой адаптер + NAT адаптер
      - `Виртуалка Б`: Сетевой адаптер + NAT адаптер
30. Далее опишу, как у нас в банке проходила миграция. Я писал скрипт, который собирал `Prometheus` в архив из текущих файлов с тачки и перекидывал архив на соседний сервер
    - На этом этапе мы прогонять этот скрипт не будем, так как уже было написано достаточно скриптов для понимания их работы
31. Далее подумать, как с помощью утилиты `SCP` перекинуть изначально скачанный архив `Prometheus` с тачки `А` на тачку `Б` (проделать миграцию):
    - Нужно иметь ввиду, что перекидывать архив нужно в директорию `/tmp` (прочитайте за что она отвечает)
32. Далее скрипт на распаковку смигрированного архива и установку `Prometheus` мы писать не будем (действуем по аналогии с предыдущим пунктом), так как уже было написано достаточно скриптов для понимания их работы

## Выводы
В банке эта задача (здесь она слегка модернизирована) была моим первым кейсом на должности разработчика мониторинга. На задачу мне дали максимум 3 дня. На третий день уже была миграция. **Мой уровень был**: умею создавать файлы, переходить в директории, запускаю скрипты (не пишу), знаю как сохранить файл и выйти из Vim, знаю как выставлять права на файлы и распаковываю архивы.
