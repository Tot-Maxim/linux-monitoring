# Prometheus

## Введение
### Как работает Prometheus и для чего он нужен

**Prometheus** — это система мониторинга с открытым исходным кодом, созданная для сбора и анализа метрик производительности систем и приложений. Он был разработан специально для работы в условиях микросервисной архитектуры и активно используется в экосистеме Kubernetes.

### **Для чего нужен Prometheus:**
- **Мониторинг производительности:** Отслеживание метрик производительности серверов, контейнеров, баз данных, приложений.
- **Обнаружение проблем:** Быстрое выявление проблем в работе системы через алертинг и анализ метрик.
- **Оптимизация ресурсов:** Анализ использования ресурсов (CPU, память, диск, сеть) для оптимизации инфраструктуры.
- **Прогнозирование:** Использование исторических данных для прогнозирования будущих нагрузок и планирования масштабирования.
- **Интеграция с микросервисами:** Простая интеграция с современными архитектурами, такими как Kubernetes, Docker, и другие облачные платформы.

### **Как работает Prometheus:**
1. **Сбор данных**:
   - Prometheus периодически выполняет скрейпинг метрик с целевых систем через экспортеры.
   - Метрики предоставляются в формате временных рядов, где каждая точка данных связана с меткой времени.
2. **Хранение данных**:
   - Собранные метрики сохраняются во встроенной базе данных временных рядов (TSDB).
   - Данные организованы в блоки, каждый из которых охватывает конкретный временной интервал.
3. **Анализ данных**:
   - Prometheus предоставляет язык запросов PromQL для анализа и агрегации данных.
   - Пользователи могут выполнять сложные запросы для получения статистики, расчета производных показателей и построения графиков.
4. **Управление алертами**:
   - Prometheus отправляет алерты в Alertmanager, если заданные условия нарушаются.
   - Alertmanager обрабатывает алерты, группирует их и направляет уведомления через настроенные каналы.
5. **Долгосрочное хранение**:
   - Для архивации данных за пределами TSDB можно использовать внешние системы хранения, такие как Thanos или Cortex.
6. **Визуализация**:
   - Prometheus может работать с Grafana для создания дашбордов, что позволяет наглядно представлять данные о производительности.


### Форматы метрик 

**Prometheus text-based format** — это стандартный формат представления метрик, используемый в экосистеме Prometheus для обмена данными между различными компонентами. Этот формат является текстовым и ориентированным на строки (line-oriented). Каждая строка отделяется символом `\n` (перевод строки), а последняя строка должна также заканчиваться этим символом. 

Помимо **Prometheus text-based format**, существуют другие форматы:

1. **OpenMetrics**  
   OpenMetrics является стандартным форматом, разработанным на основе Prometheus text-based format, но с дополнительными возможностями и улучшениями для обеспечения большей совместимости между различными системами мониторинга. Этот формат также текстовый и поддерживается Prometheus начиная с версии 2.0.  
   Пример использования:  
   ```
   # HELP http_requests_total Total number of HTTP requests
   # TYPE http_requests_total counter
   http_requests_total{method="get",code="200"} 1024
   ```

2. **Prometheus Protobuf Format**  
   Это двоичный формат, основанный на протоколе Protocol Buffers (Protobuf). Он используется для более эффективной передачи больших объемов данных по сравнению с текстовым форматом. Хотя этот формат менее человечески читаемый, он более компактный и быстрый в обработке.  

3. **JSON Format**  
   Некоторые системы и экспортеры могут предоставлять метрики в формате JSON, который затем преобразуется в формат Prometheus. Однако это не является стандартным способом для Prometheus, и обычно такие данные требуют промежуточной обработки через специальные адаптеры или скрипты.  

### Сравнение форматов:
- **Prometheus text-based format**: Человечески читаемый, простой в реализации, широко используется для экспозиции метрик.
- **OpenMetrics**: Совместим с Prometheus text-based format, но более универсален и стандартизирован.
- **Prometheus Protobuf Format**: Более эффективен для передачи больших объемов данных, но менее удобен для ручного анализа.
- **JSON**: Используются реже для передачи метрик, но может применяться в специфических случаях с дополнительной обработкой.

---

### **Схема работы Prometheus**

Эта схема показывает полный цикл работы Prometheus: от сбора метрик до отправки уведомлений через Alertmanager. Включает как pull-модель для экспортеров, так и push-модель для временных задач:
            
```mermaid
sequenceDiagram
    participant App as "Приложение"
    participant Exporter as "Экспортер"
    participant Prometheus as "Prometheus Server"
    participant Pushgateway as "Pushgateway"
    participant Alertmanager as "Alertmanager"
    participant Notification as "Уведомление"

    App->>Exporter: Предоставляет данные
    loop Каждые N секунд
        Prometheus->>Exporter: Pull метрик (скрейпинг)
        Exporter-->>Prometheus: Ответ с метриками
    end
    BatchJob->>Pushgateway: Push метрик
    Prometheus->>Pushgateway: Pull метрик (скрейпинг)
    Pushgateway-->>Prometheus: Ответ с метриками
    Prometheus->>Alertmanager: Отправка алертов
    Alertmanager->>Notification: Отправка уведомлений
```

### Давайте разберем её детально:

1. **Приложение → Экспортер**: Приложение предоставляет данные через экспортеры, которые могут быть встроены или внешними инструментами, такими как Node Exporter или Custom Exporter.

2. **Prometheus → Экспортер (Pull)**: Prometheus периодически запрашивает (скрейпит) метрики у экспортеров по расписанию, используя pull-модель. Это означает, что сам сервер Prometheus инициирует запросы к HTTP-интерфейсам экспортеров для получения актуальных данных.

3. **BatchJob → Pushgateway (Push)**: Временные задачи (BatchJobs), которые не могут быть постоянно доступны для скрейпинга из-за своей кратковременной природы, отправляют свои метрики напрямую в Pushgateway через push-модель. Это позволяет сохранить метрики до тех пор, пока они не будут собраны Prometheus. Отправка метрик осуществляется посредством HTTP POST-запросов к определенному URL Pushgateway, где метрики передаются в формате, совместимом с Prometheus (Prometheus text-based format, OpenMetrics).

5. **Prometheus → Pushgateway (Pull)**: Несмотря на то, что метрики были отправлены через push-модель, Prometheus всё ещё выполняет pull-операцию, забирая последние метрики из Pushgateway в соответствии со своим циклом скрейпинга. Таким образом, Pushgateway выступает как промежуточный буфер между временными задачами и Prometheus.

6. **Prometheus → Alertmanager**: После сбора данных, если определённые условия выполнены, Prometheus отправляет алерты в Alertmanager для дальнейшей обработки и управления уведомлениями.

7. **Alertmanager → Уведомление**: Alertmanager направляет уведомления через различные каналы, такие как email, Slack, или другие системы, чтобы информировать операторов о проблемах или событиях.

---

### Как приложения взаимодействуют с Pushgateway
Приложения, которые отправляют свои метрики напрямую в Pushgateway через push-модель, обычно используют HTTP-протокол и формат Prometheus для передачи данных. Примеры:

1. **Batch Jobs (временные задачи)**: Это могут быть скрипты или программы, выполняемые планировщиком задач (например, cron jobs). Поскольку такие задачи могут завершаться до того, как Prometheus успеет их проскрейпить, они отправляют свои метрики в Pushgateway перед завершением работы.

   - **Пример**: Скрипт Python, который использует клиентскую библиотеку Prometheus для сбора метрик и отправляет их в Pushgateway.
   - **Формат**: Метрики должны быть в формате, понятном Prometheus (текстовый формат с определённой структурой).
   - **API**: Используется HTTP API Pushgateway. Обычно это POST-запрос на `/metrics/job/<job_name>`.

2. **Flink-коннектор к Prometheus**: В контексте больших данных, Flink может использовать специальный репортер (`PrometheusPushGatewayReporter`), который отправляет метрики в Pushgateway, чтобы Prometheus мог их считывать.

3. **Кастомные приложения**: Любые приложения, разработанные с использованием клиентских библиотек Prometheus (для Java, Python, Go и других языков), могут быть инструментированы для отправки метрик в Pushgateway.

### Пример кода на Python:
```python
from prometheus_client import CollectorRegistry, Gauge, push_to_gateway

registry = CollectorRegistry()
g = Gauge('job_last_success', 'Last job success', registry=registry)
g.set(1)

push_to_gateway('localhost:9091', job='batch_job_example', registry=registry)
```

В этом примере:
- Используется библиотека `prometheus_client` для Python.
- Создаётся регистратор метрик (`CollectorRegistry`) и создаётся метрика типа `Gauge`.
- Значение метрики устанавливается, а затем отправляется в Pushgateway с помощью функции `push_to_gateway`.

### Протокол и формат:
- **Протокол**: HTTP.
- **Формат**: Текстовый формат, специфичный для Prometheus. Например:
  ```
  # HELP job_last_success Last job success
  # TYPE job_last_success gauge
  job_last_success 1
  ```

Приложения, использующие Pushgateway, должны иметь возможность формировать метрики в формате Prometheus и отправлять их через HTTP POST-запросы на соответствующий эндпоинт Pushgateway.

---

```mermaid
sequenceDiagram
    participant App as "Приложение"
    participant Exporter as "Экспортер"
    participant Prometheus as "Prometheus Server"
    participant Pushgateway as "Pushgateway"
    participant Alertmanager as "Alertmanager"
    participant Notification as "Уведомление"

    App->>Exporter: Предоставляет данные
    
    loop Каждые N секунд
        Prometheus->>Exporter: HTTP GET (Pull метрик)
        Exporter-->>Prometheus: HTTP 200 OK + Текстовые метрики
    end
    
    BatchJob->>Pushgateway: HTTP POST (Push метрик)
    Prometheus->>Pushgateway: HTTP GET (Pull метрик)
    Pushgateway-->>Prometheus: HTTP 200 OK + Текстовые метрики
    
    Prometheus->>Alertmanager: HTTP POST (Отправка алертов) [JSON формат]
    Alertmanager->>Notification: Отправка уведомлений (HTTP, Webhook, Email)
```
