## Лейбл (Label)

**Лейбл (Label)** — это пара ключ-значение, добавляющая контекст к метрике. Например, метрика `http_requests_total` может иметь лейблы `method="POST"`, `path="/api"`, `status_code="200"`, что позволяет группировать и фильтровать данные.

   #### Как используются лейблы в PromQL?
   
   - Фильтрация:  
     `http_requests_total{status="500"}`         # Выведет только 500-ые статусы по лейблу **status**
   - Группировка:  
     `sum by (method) (http_requests_total)`     # Отсортирует сумму по лейблу **method** каждого HTTP запроса
   - Агрегация:  
     `rate(http_requests_total{job="api"}[5m])`  # Cчитает прирост значения метрики за последние 5 минут при обращении к лейблу **job**

**Relabel_config** в Prometheus — это механизм для изменения или фильтрации меток (labels) целевых объектов (targets) во время сбора метрик. Он позволяет модифицировать, добавлять или удалять метки перед тем, как они будут использованы для группировки данных или хранения в базе Prometheus.

### Основная цель **relabel_config**:
1. **Фильтрация целей**: Исключить ненужные или неактуальные цели из процесса скрапинга.
2. **Модификация меток**: Изменить или переименовать существующие метки.
3. **Добавление новых меток**: Создать дополнительные метки на основе значений других меток.
4. **Управление маршрутизацией**: Настроить, какие метки будут использоваться для определения правил маршрутизации и агрегации.

---

### Как работает **relabel_config**?

Когда Prometheus получает список целей (например, через файл статических конфигураций или сервис-дискавери), каждая цель проходит через несколько этапов обработки, включая relabeling. Этот процесс выполняется последовательно, и результат одного шага становится входными данными для следующего.

#### Основные параметры **relabel_config**:

1. **`source_labels`**:
   - Указывает, какие метки должны быть использованы в качестве источника для преобразования.
   - Например: `source_labels: [__address__]`.

2. **`target_label`**:
   - Указывает метку, которая будет создана или изменена.
   - Например: `target_label: instance`.

3. **`regex`**:
   - Регулярное выражение, которое применяется к значениям меток из `source_labels`.
   - По умолчанию используется `(?.*)`, что означает "любое значение".

4. **`replacement`**:
   - Значение, которым будет заменено совпадение регулярного выражения.
   - Может содержать обратные ссылки на группы захвата из `regex` (например, `$1`).

5. **`action`**:
   - Определяет, что делать с метками:
     - `replace`: Заменяет значение метки (по умолчанию).
     - `keep`: Оставляет только те цели, которые соответствуют `regex`.
     - `drop`: Удаляет цели, которые соответствуют `regex`.
     - `labelmap`: Применяет `regex` ко всем меткам и создает новые метки.
     - `labeldrop`: Удаляет метки, чьи имена соответствуют `regex`.
     - `labelkeep`: Сохраняет только метки, чьи имена соответствуют `regex`.

---

### Пример использования **relabel_config**

#### 1. Простая замена метки:
Если вы хотите переименовать метку `__address__` в `instance`:
```yaml
relabel_configs:
  - source_labels: [__address__]
    target_label: instance
    replacement: $1
```

#### 2. Фильтрация целей:
Если вы хотите собирать данные только с целей, чьи адреса начинаются с `localhost`:
```yaml
relabel_configs:
  - source_labels: [__address__]
    regex: localhost:.*
    action: keep
```

#### 3. Добавление новой метки:
Если вы хотите добавить метку `environment` со значением `production`:
```yaml
relabel_configs:
  - target_label: environment
    replacement: production
```

#### 4. Извлечение части строки:
Если адрес целей имеет формат `host:port` и вы хотите сохранить только имя хоста:
```yaml
relabel_configs:
  - source_labels: [__address__]
    target_label: instance
    regex: ([^:]+):.*
    replacement: $1
```

---

### Порядок выполнения

Важно помнить, что правила `relabel_config` выполняются **в том порядке, в котором они указаны**. Поэтому порядок правил может влиять на результат.

---

### Зачем нужен **relabel_config**?

1. **Стандартизация меток**: Обеспечивает единообразие в именах меток и их значениях.
2. **Оптимизация скрапинга**: Исключает ненужные цели, что снижает нагрузку на систему.
3. **Гибкость**: Позволяет адаптировать метки под конкретные требования мониторинга.

Таким образом, **relabel_config** — это мощный инструмент для управления метками и настройки процесса сбора данных в Prometheus.
