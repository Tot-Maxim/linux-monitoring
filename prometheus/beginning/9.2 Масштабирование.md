### Федерация в Prometheus

**Федерация (Federation)** в системе мониторинга Prometheus представляет собой механизм, позволяющий одному экземпляру Prometheus получать метрики напрямую из другого экземпляра Prometheus. Этот подход используется для организации иерархической или горизонтальной агрегации данных между разными экземплярами Prometheus, что особенно полезно в распределенных и крупномасштабных системах.

---

### **Как работает федерация в Prometheus**

1. **Иерархическая структура сбора данных**:
   - В модели федерации один или несколько "нижних" экземпляров Prometheus (child instances) собирают метрики с целевых систем или сервисов.
   - "Верхний" экземпляр Prometheus (parent instance) конфигурируется для скрейпинга определенных метрик с нижних экземпляров через специальный endpoint `/federate`.

2. **Выборка метрик**:
   - Верхний экземпляр может выбирать конкретные метрики для сбора с помощью параметров запроса, таких как `match[]`.
   - Например, запрос `match[]={http_requests_total}` позволяет верхнему экземпляру получить только метрику `http_requests_total` из нижнего экземпляра.

3. **Объединение данных**:
   - Собранные метрики из нижних экземпляров объединяются с локальными метриками верхнего экземпляра, образуя единую базу данных временных рядов.
   - Это позволяет выполнять агрегированные запросы на уровне всей системы, даже если данные собираются несколькими независимыми экземплярами Prometheus.

4. **Метки и идентификация источников**:
   - Каждая метрика, собранная через федерацию, автоматически получает дополнительные метки, такие как `prometheus=<instance_name>`, чтобы идентифицировать источник данных.
   - Это обеспечивает возможность различать метрики, собранные разными экземплярами Prometheus.

---

### **Зачем нужна федерация**

1. **Масштабируемость**:
   - Федерация позволяет разделить нагрузку по сбору метрик между несколькими экземплярами Prometheus, что особенно важно в крупных системах с большим количеством целевых объектов.
   - Например, каждый кластер Kubernetes может иметь свой локальный экземпляр Prometheus, а центральный экземпляр будет агрегировать ключевые метрики со всех кластеров.

2. **Изолирование областей ответственности**:
   - Разные экземпляры Prometheus могут быть настроены для мониторинга различных подсистем или географических регионов.
   - Центральный экземпляр Prometheus может агрегировать только важные метрики из этих подсистем, минимизируя объем данных, которые необходимо хранить централизованно.

3. **Глобальная видимость**:
   - Федерация обеспечивает возможность получения обобщенной картины производительности всей системы без необходимости собирать все детальные метрики в одном месте.
   - Это позволяет создавать дашборды и алерты на уровне всей инфраструктуры, основываясь на агрегированных данных.

4. **Управление доступом**:
   - В некоторых случаях разные команды или отделы могут иметь свои изолированные экземпляры Prometheus для мониторинга своих служб.
   - Федерация позволяет центральной команде получать только необходимые метрики, не нарушая изоляцию данных.

---

### **Пример использования федерации**

Рассмотрим сценарий, где есть три кластера Kubernetes (A, B, C), каждый с собственным экземпляром Prometheus. Эти экземпляры собирают подробные метрики о работе приложений внутри своих кластеров. Центральный экземпляр Prometheus настроен для федерации и собирает только ключевые метрики (например, `http_requests_total`, `error_rate`) со всех трех кластеров. Это позволяет:

- Мониторить общее состояние всех кластеров.
- Создавать агрегированные графики и алерты на уровне всей инфраструктуры.
- Минимизировать нагрузку на центральный экземпляр Prometheus, так как он не собирает все детальные метрики.

---

### **Преимущества федерации**

1. **Декомпозиция сложности**: Разделение процесса сбора метрик между несколькими экземплярами Prometheus упрощает управление и снижает риск перегрузки одного центрального сервера.
2. **Оптимизация ресурсов**: Только важные метрики передаются на уровень выше, что минимизирует использование сетевых и вычислительных ресурсов.
3. **Гибкость архитектуры**: Возможность создания иерархических или горизонтальных связей между экземплярами Prometheus делает федерацию универсальным решением для различных сценариев мониторинга.

