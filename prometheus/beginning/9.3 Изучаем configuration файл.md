## Prometheus

### Разберём конфигурацию

Разбор конфига для связки: **Node Exporter**, **Process Exporter**, **Blackbox Exporter**, **Alertmanager**, **remote read/write** и **relabel config**.

---

### **Пример конфигурации Prometheus (`[prometheus.yml](https://github.com/lamjob1993/linux-monitoring/blob/main/prometheus/beginning/prometheus.yaml)`)**

---

### **Разберём основные части конфигурации:**

#### **1. `global`**
- **`scrape_interval`**: Как часто Prometheus будет собирать метрики с целевых узлов.
- **`evaluation_interval`**: Как часто Prometheus будет проверять правила алертинга.

#### **2. `alerting`**
- **`alertmanagers`**: Настройки Alertmanager, куда Prometheus будет отправлять алерты.
  - **`targets`**: Адрес Alertmanager (по умолчанию `localhost:9093`).

#### **3. `rule_files`**
- **`alert_rules.yml`**: Файл с правилами алертинга. Пример содержимого:
  ```yaml
  groups:
    - name: example
      rules:
        - alert: HighCpuUsage
          expr: 100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100 > 80
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "High CPU usage detected on {{ $labels.instance }}"
  ```

#### **4. `remote_write` и `remote_read`**
- **`remote_write`**: Куда отправлять метрики (например, в Mimir, Thanos, Cortex или другой удалённый storage).
- **`remote_read`**: Откуда читать метрики (например, из удалённого хранилища).

#### **5. `scrape_configs`**
- **`job_name`**: Имя задачи для сбора метрик.
- **`static_configs`**: Список целевых узлов (targets), с которых собираются метрики.
- **`relabel_configs`**: Правила для переименования лейблов или изменения значений метрик.

---

### **Что такое `relabel_configs`?**
`relabel_configs` — это механизм для изменения метаданных (лейблов) перед тем, как метрики будут сохранены в Prometheus. Он используется для:
- Переименования лейблов.
- Фильтрации метрик.
- Добавления или удаления лейблов.

#### Пример `relabel_configs`:
```yaml
relabel_configs:
  - source_labels: [__address__]    # Исходный лейбл (адрес целевого узла).
    target_label: __param_target    # Новый лейбл (параметр для запроса).
  - source_labels: [__param_target]
    target_label: instance          # Новый лейбл (имя инстанса).
  - target_label: __address__
    replacement: 'ip_adderess:9100'   # Замена адреса целевого узла.
```

---

### **Итог:**
- **Node Exporter**: Собирает метрики ОС (CPU, память, диски).
- **Process Exporter**: Собирает метрики по процессам.
- **Blackbox Exporter**: Проверяет доступность сервисов (HTTP, TCP, ICMP).
- **Alertmanager**: Управляет алертами.
- **Remote Read/Write**: Интеграция с удалёнными хранилищами (например, Thanos или Mimir).
- **Relabel Configs**: Переименование и фильтрация лейблов.
