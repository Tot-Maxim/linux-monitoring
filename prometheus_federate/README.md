В конфигурации Prometheus параметр `params` используется для передачи дополнительных параметров в запросы HTTP, которые Prometheus отправляет при сборе метрик. В данном случае, параметр `match[]` — это специальный параметр, который используется в федерации Prometheus для выбора определенных метрик из удаленного экземпляра Prometheus.

### Разберем построчно:

```yaml
params:
  'match[]':
    - '{job="node-exporter"}'
    - '{__name__=~"up|process_cpu_usage"}'
```

#### 1. **`params`**
Это секция в конфигурации, где вы можете указать дополнительные параметры для HTTP-запросов, которые Prometheus будет отправлять на целевой endpoint. В случае федерации, мы используем этот параметр для фильтрации метрик, которые нужно собрать с удаленного Prometheus.

#### 2. **`match[]`**
`match[]` — это специальный параметр, который позволяет выбрать подмножество метрик из удаленного экземпляра Prometheus. Он принимает список строк, каждая из которых представляет собой PromQL-подобное выражение для фильтрации метрик.

#### 3. **`'{job="node-exporter"}'`**
Это одно из выражений для фильтрации метрик. Оно говорит Prometheus выбирать только те метрики, у которых лейбл `job` равен `"node-exporter"`. Это может быть полезно, если вы хотите агрегировать только метрики, связанные с мониторингом хостов (например, CPU, память, диск и т.д.), которые собираются через `node-exporter`.

#### 4. **`'{__name__=~"up|process_cpu_usage"}'`**
Это второе выражение для фильтрации метрик. Здесь используется регулярное выражение (`=~`) для выбора метрик по их имени (`__name__`). Конкретно это выражение выбирает метрики с именами `up` или `process_cpu_usage`.

- `up`: Это метрика, которая показывает статус доступности целевого сервиса (1 — доступен, 0 — недоступен).
- `process_cpu_usage`: Это метрика, которая показывает использование CPU процессом.

Таким образом, это выражение позволяет выбрать только эти две метрики из всех доступных в удаленном Prometheus.

---

### Что происходит в целом?

Когда центральный Prometheus делает запрос к локальному Prometheus через `/federate` endpoint, он добавляет параметры `match[]` в URL-адрес запроса. Например, запрос может выглядеть так:

```
GET /federate?match[]={job="node-exporter"}&match[]={__name__=~"up|process_cpu_usage"}
```

Локальный Prometheus обрабатывает этот запрос, фильтрует метрики согласно указанным условиям и возвращает только те метрики, которые соответствуют этим правилам.

---

### Почему это полезно?

Использование `match[]` позволяет центральному Prometheus собирать только необходимые метрики, а не все данные, что помогает снизить нагрузку на центральный экземпляр Prometheus и сэкономить ресурсы (память, диск и т.д.). Это особенно важно в больших системах, где объем метрик может быть очень большим.

---

### Пример без фильтрации

Если бы мы не использовали `match[]`, то центральный Prometheus собрал бы **все** метрики с удаленного экземпляра Prometheus. Это может привести к чрезмерной нагрузке на центральный Prometheus и усложнить анализ данных.

Например, без фильтрации запрос мог бы выглядеть так:

```
GET /federate
```

В этом случае Prometheus вернет все метрики, которые есть в удаленном экземпляре.

---

### Итог

Параметр `match[]` в секции `params` позволяет фильтровать метрики при федерации Prometheus. Он используется для выбора конкретных метрик, которые нужно агрегировать в центральном Prometheus, основываясь на их лейблах или именах. Это помогает оптимизировать работу системы мониторинга и снизить нагрузку на центральный экземпляр.
